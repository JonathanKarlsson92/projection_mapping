<!DOCTYPE html>
<html>
<head>
<!--<script type="text/javascript" src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
<script type="text/javascript" src="http://cdn.robotwebtools.org/roslibjs/current/roslib.min.js"></script> -->

<meta charset="utf-8">
<script src="https://cdn.rawgit.com/konvajs/konva/1.7.6/konva.min.js"></script>
<script src="roslibjs/build/roslib.js"></script>
<script type="text/javascript" type="text/javascript">


// This function connects to the rosbridge server running on the local computer on port 9090
var rbServer = new ROSLIB.Ros({
	url : 'ws://localhost:9090'
});

 // This function is called upon the rosbridge connection event
 rbServer.on('connection', function() {
	// Write appropriate message to #feedback div when successfully connected to rosbridge
	var fbDiv = document.getElementById('feedback');
	fbDiv.innerHTML += "<p>Connected to websocket server.</p>";
});

// This function is called when there is an error attempting to connect to rosbridge
rbServer.on('error', function(error) {
	// Write appropriate message to #feedback div upon error when attempting to connect to rosbridge
	var fbDiv = document.getElementById('feedback');
	fbDiv.innerHTML += "<p>Error connecting to websocket server.</p>";
});

// This function is called when the connection to rosbridge is closed
rbServer.on('close', function() {
	// Write appropriate message to #feedback div upon closing connection to rosbridge
	var fbDiv = document.getElementById('feedback');
	fbDiv.innerHTML += "<p>Connection to websocket server closed.</p>";
 });

//Define array to hold the data from ar_projection message
var p=[9];

//set width and heigt to size of current window(in the browser)
var width = window.innerWidth;
var height = window.innerHeight;

//Define listener, listening to ar_projection
var listener = new ROSLIB.Topic({
	ros : rbServer,
	name : '/ar_projection',	
	//messageType : 'projection_mapping/Transformed_marker'
	messageType : 'projection_mapping/Ar_projection'
});

listener.subscribe(function(message) {
	//If message not empty
	if(message.markers.length>0){
		//Printing the marker id and position from the recieved message
		console.log('Number of markers seen' + message.markers.length);
		console.log('p1: ' +'     x: ' +message.markers[0].p1.X+ '    y: ' + message.markers[0].p1.Y);
		console.log('p2: ' +'     x: ' +message.markers[0].p2.X+ '    y: ' + message.markers[0].p2.Y);
		console.log('p3: ' +'     x: ' +message.markers[0].p3.X+ '    y: ' + message.markers[0].p3.Y);
		console.log('p4: ' +'     x: ' +message.markers[0].p4.X+ '    y: ' + message.markers[0].p4.Y);

		p[0]=message.markers[0].id;	
		p[1]=width*(message.markers[0].p1.X+0.5);	//moved from c++ file to here, the c++ file is independent of the resolution which is defined here.
		p[2]=height*(message.markers[0].p1.Y+0.5);	//p1-4 is the offset from the middle in percent(0-1) 
		p[3]=width*(message.markers[0].p2.X+0.5);	//coordinates are moved from the center to topleft corner(all positive)
		p[4]=height*(message.markers[0].p2.Y+0.5);
		p[5]=width*(message.markers[0].p3.X+0.5);
		p[6]=height*(message.markers[0].p3.Y+0.5);
		p[7]=width*(message.markers[0].p4.X+0.5);
		p[8]=height*(message.markers[0].p4.Y+0.5);


	}
});


</script>
</head>

<body bgcolor="black">
<div id="feedback"></div> 
<div id="container"></div>
<script>

	//define stage
	var stage = new Konva.Stage({
		container: 'container',
		width: width,
		height: height
	});

	//define konva layer
	var layer = new Konva.Layer();

	//Initialize poly
	var poly = new Konva.Line({
		points: [0,0,0,0,0,0,0,0],	
		fill: '#00D2FF',
		stroke: 'black',
		strokeWidth: 5,
		closed : true
	});
	//Add to layer and stage
	layer.add(poly);
	stage.add(layer);
	var anim = new Konva.Animation(function() {
		//Poly is updated with the latest info from the camera
		//if it is the cube, paint it red else blue

		//modify all objects
		if(p[0]==9) {
			poly.setFill('#ff0000');
		}else{
			poly.setFill('#00D2FF');
		}
		console.log('p1: ' +'     x: ' +p[1]+ '    y: ' + p[2]);
		console.log('p2: ' +'     x: ' +p[3]+ '    y: ' + p[4]);
		console.log('p3: ' +'     x: ' +p[5]+ '    y: ' + p[6]);
		console.log('p4: ' +'     x: ' +p[7]+ '    y: ' + p[8]);
		poly.setPoints([p[1], p[2], p[3], p[4], p[5], p[6], p[7], p[8]]);
		
	}, layer);

	anim.start();
</script>
</body>
</html>
